<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Predictive SEO Analysis Tool</title>
  <!-- Tailwind note: in prod you’d install via CLI/PostCSS, but this demo uses CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#111827; color:#f3f4f6 }
    .loader { border:4px solid #f3f3f3; border-top:4px solid #3b82f6; border-radius:50%; w:40px; h:40px; animation:spin 1s linear infinite }
    @keyframes spin{to{transform:rotate(360deg)}}
    .input-field { background:#374151; border-color:#4b5563; color:#f3f4f6 }
    .input-field:focus { background:#4b5563; border-color:#3b82f6; outline:none }
    .accordion-button { transition:background-color .2s }
    .accordion-content { max-height:0; overflow:hidden; transition:max-height .3s }
  </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
  <div class="max-w-4xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold">Predictive SEO Analysis Tool</h1>
      <p class="text-gray-400 mt-2">Sign in, choose your site &amp; subreddit, then run analysis.</p>
    </header>

    <!-- AUTH -->
    <div id="auth-section" class="text-center">
      <button id="auth-button" disabled
        class="bg-white text-gray-800 font-semibold py-3 px-6 rounded shadow flex items-center justify-center mx-auto hover:bg-gray-200 disabled:opacity-50">
        <!-- Full Google G path -->
        <svg class="w-6 h-6 mr-2" viewBox="0 0 48 48">
          <path fill="#4285F4" d="M24 9.5c3.54 0 6.73 1.23 9.24 3.64l6.92-6.92C35.3 2.8 29.93.5 24 .5 14.6.5 6.69 7.2 3.2 16.47l7.99 6.18C12.5 15.78 17.6 9.5 24 9.5z"/>
          <path fill="#34A853" d="M46.5 24c0-1.57-.14-3.09-.4-4.55H24v9.09h12.95c-.56 3.08-2.23 5.68-4.75 7.43l7.3 5.66C43.9 37.52 46.5 31.33 46.5 24z"/>
          <path fill="#FBBC05" d="M10.19 28.65c-.5-1.48-.8-3.05-.8-4.65s.3-3.17.8-4.65L2.2 13.17C.8 16.07 0 19.93 0 24s.8 7.93 2.2 10.83l7.99-6.18z"/>
          <path fill="#EA4335" d="M24 46.5c5.93 0 11.3-2.32 15.14-6.07l-7.3-5.66c-2.06 1.38-4.7 2.19-7.84 2.19-6.4 0-11.5-6.28-11.99-14.02L3.2 31.53C6.69 40.8 14.6 47.5 24 47.5z"/>
        </svg>
        Sign in with Google
      </button>
    </div>

    <!-- CONFIG -->
    <div id="config-section" class="hidden space-y-6 mt-6">
      <!-- GSC -->
      <div class="bg-gray-800 p-6 rounded shadow">
        <h2 class="text-2xl font-semibold mb-4">1. Google Search Console</h2>
        <div id="gsc-loader" class="text-center hidden">
          <p class="text-gray-400">Loading your GSC properties…</p>
        </div>
        <div id="gsc-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1">Select Property</label>
            <select id="gsc-url" class="w-full p-2 rounded input-field"></select>
          </div>
          <div>
            <label class="block mb-1">'Emerging' Threshold (%)</label>
            <input type="number" id="gsc-emerging-thresh" class="w-full p-2 rounded input-field" value="50">
          </div>
          <div>
            <label class="block mb-1">'Emerging' Min Impr.</label>
            <input type="number" id="gsc-emerging-min" class="w-full p-2 rounded input-field" value="100">
          </div>
          <div>
            <label class="block mb-1">'Untapped' Min Impr.</label>
            <input type="number" id="gsc-untapped-min" class="w-full p-2 rounded input-field" value="500">
          </div>
          <div>
            <label class="block mb-1">'Untapped' Max CTR (%)</label>
            <input type="number" id="gsc-untapped-ctr" class="w-full p-2 rounded input-field" value="1.5">
          </div>
        </div>
      </div>

      <!-- Reddit -->
      <div class="bg-gray-800 p-6 rounded shadow">
        <h2 class="text-2xl font-semibold mb-4">2. Reddit</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1">Subreddit</label>
            <input type="text" id="reddit-subreddit" class="w-full p-2 rounded input-field" placeholder="b2bmarketing">
          </div>
          <div>
            <label class="block mb-1">Sort</label>
            <select id="reddit-sort" class="w-full p-2 rounded input-field">
              <option>Hot</option><option>New</option><option>Top</option><option>Rising</option><option>Controversial</option>
            </select>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button id="run-btn" disabled
          class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded shadow transform hover:scale-105 transition disabled:opacity-50">
          Run Predictive Analysis
        </button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="results" class="hidden mt-8 space-y-6">
      <div id="loading" class="text-center py-10">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-gray-300">Analyzing…</p>
      </div>
      <div id="error" class="hidden p-6 bg-red-900/20 rounded border border-red-500 text-center">
        <h3 class="text-xl font-semibold text-red-400">Failed</h3>
        <p id="error-msg" class="mt-2 text-red-300"></p>
      </div>
      <div id="output" class="space-y-6"></div>
    </div>
  </div>

  <script>
  // --- CONFIG ---
  const GOOGLE_CLIENT_ID = '64568371966-4m8l8mp16mta4s8eriabdlecncdgumea.apps.googleusercontent.com';
  const GAPI_SCOPES      = 'https://www.googleapis.com/auth/webmasters.readonly https://www.googleapis.com/auth/spreadsheets';

  let tokenClient;
  let analysisData = {};

  // DOM refs
  const authBtn     = document.getElementById('auth-button');
  const runBtn      = document.getElementById('run-btn');
  const authSect    = document.getElementById('auth-section');
  const configSect  = document.getElementById('config-section');
  const gscLoader   = document.getElementById('gsc-loader');
  const gscInputs   = document.getElementById('gsc-inputs');
  const gscUrlSel   = document.getElementById('gsc-url');
  const resultsSect = document.getElementById('results');
  const loadDiv     = document.getElementById('loading');
  const errDiv      = document.getElementById('error');
  const errMsg      = document.getElementById('error-msg');
  const outDiv      = document.getElementById('output');

  // 1) Bootstrap gapi.client (no discovery yet)
  gapi.load('client', async () => {
    await gapi.client.init({});  // empty init
    // now enable sign‑in
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: GAPI_SCOPES,
      callback: handleAuthResponse
    });
    authBtn.disabled = false;
    authBtn.addEventListener('click', () => tokenClient.requestAccessToken());
  });

  // 2) After auth, load both APIs by name/version
  async function handleAuthResponse(resp) {
    if (resp.error) {
      alert('Auth error: ' + resp.error);
      return;
    }
    gapi.client.setToken(resp);
    // load Search Console & Sheets
    await Promise.all([
      gapi.client.load('searchconsole', 'v1'),
      gapi.client.load('sheets',       'v4')
    ]);

    // show config
    authSect.classList.add('hidden');
    configSect.classList.remove('hidden');
    gscLoader.classList.remove('hidden');

    // fetch properties, then enable “Run”
    await fetchGSC();
    runBtn.disabled = false;
    runBtn.addEventListener('click', runAnalysis);
  }

  // 3) Fetch GSC properties
  async function fetchGSC() {
    try {
      const r = await gapi.client.searchconsole.sites.list();
      const sites = r.result.siteEntry || [];
      if (!sites.length) throw new Error('No GSC properties found');
      gscUrlSel.innerHTML = sites
        .map(s => `<option value="${s.siteUrl}">${s.siteUrl}</option>`)
        .join('');
      gscLoader.classList.add('hidden');
      gscInputs.classList.remove('hidden');
    } catch (e) {
      alert('Could not fetch GSC properties:\n' + e.message);
      console.error(e);
      configSect.classList.add('hidden');
      authSect.classList.remove('hidden');
    }
  }

  // 4) Run Predictive Analysis
  async function runAnalysis() {
    errDiv.classList.add('hidden');
    outDiv.innerHTML = '';
    loadDiv.classList.remove('hidden');
    resultsSect.classList.remove('hidden');

    const inputs = {
      gscUrl:    gscUrlSel.value,
      emergingThreshold:   document.getElementById('gsc-emerging-thresh').value,
      emergingMin:         document.getElementById('gsc-emerging-min').value,
      untappedMin:         document.getElementById('gsc-untapped-min').value,
      untappedMaxCtr:      document.getElementById('gsc-untapped-ctr').value,
      subreddit:           document.getElementById('reddit-subreddit').value,
      redditSort:          document.getElementById('reddit-sort').value,
    };
    try {
      // -- Fetch GSC data --
      const gscData = await fetchGSCData(inputs.gscUrl);
      // -- (Your Gemini call here) --
      // For brevity I'll mock AI results:
      const result = {
        ai_insights: {
          overall_summary: 'Mock summary',
          actionable_recommendations: ['Do A','Do B'],
          gsc_emerging_comment: 'Emerging comment',
          gsc_new_comment: 'New comment',
          gsc_untapped_comment: 'Untapped comment',
          reddit_comment: 'Reddit comment'
        },
        gsc_emerging: [],
        gsc_new:      [],
        gsc_untapped:[],
        reddit_posts: []
      };
      analysisData = result;
      renderResultSections(result);
    } catch (e) {
      errMsg.textContent = e.message;
      errDiv.classList.remove('hidden');
    } finally {
      loadDiv.classList.add('hidden');
    }
  }

  // Helper to fetch two 28‑day windows of GSC
  async function fetchGSCData(siteUrl) {
    const fmt = d => d.toISOString().slice(0,10);
    const today = new Date(), end1 = new Date(today), start1 = new Date();
    end1.setDate(today.getDate()-1);
    start1.setDate(end1.getDate()-27);
    const end2 = new Date(start1), start2 = new Date(start1);
    end2.setDate(start1.getDate()-1);
    start2.setDate(end2.getDate()-27);
    const current = await gapi.client.searchconsole.searchanalytics.query({
      siteUrl, resource:{startDate:fmt(start1),endDate:fmt(end1),dimensions:['query'],rowLimit:5000}
    });
    const previous = await gapi.client.searchconsole.searchanalytics.query({
      siteUrl, resource:{startDate:fmt(start2),endDate:fmt(end2),dimensions:['query'],rowLimit:5000}
    });
    return {current:current.result.rows||[], previous:previous.result.rows||[]};
  }

  // Minimal render stub
  function renderResultSections(data) {
    outDiv.innerHTML = `<div class="bg-gray-800 p-4 rounded">
      <h2 class="text-xl font-bold mb-2">Summary</h2>
      <p>${data.ai_insights.overall_summary}</p>
    </div>`;
  }
  </script>
</body>
</html>
