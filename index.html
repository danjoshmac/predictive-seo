<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive SEO Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f3f4f6; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .input-field { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .input-field:focus { background-color: #4b5563; border-color: #3b82f6; ring: #3b82f6; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="container mx-auto max-w-3xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-white">Predictive SEO Analysis Tool</h1>
            <p class="text-gray-400 mt-3">Connect your account to uncover emerging trends and content opportunities.</p>
        </header>

        <!-- Auth Section -->
        <div id="auth-section" class="text-center">
            <button id="auth-button" class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md mx-auto hover:bg-gray-200 transition">
                Sign in with Google
            </button>
            <p class="text-xs text-gray-500 mt-3">Required for Google Search Console & Google Sheets access.</p>
        </div>

        <!-- Config Section -->
        <div id="config-section" class="hidden mt-10">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">Google Search Console</h2>
                <div id="gsc-loader" class="text-center hidden">
                    <p class="text-gray-400">Loading your GSC properties...</p>
                </div>
                <div id="gsc-config-inputs" class="hidden grid grid-cols-1 gap-6">
                    <div>
                        <label for="gsc-url-select" class="block text-sm font-medium mb-1">Select Property</label>
                        <select id="gsc-url-select" class="w-full p-2 rounded input-field"></select>
                    </div>
                    <div>
                        <label for="reddit-subreddit" class="block text-sm font-medium mb-1">Subreddit</label>
                        <input type="text" id="reddit-subreddit" class="w-full p-2 rounded input-field" placeholder="b2bmarketing">
                    </div>
                </div>
            </div>
            <div class="text-center pt-4">
                <button id="run-analysis" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200 ease-in-out">
                    Run Predictive Analysis
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden mt-12">
            <div id="loader-container" class="text-center py-10">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-lg text-gray-300">Performing analysis... This may take a moment.</p>
            </div>
            <div id="error-container" class="hidden text-center p-6 bg-red-900/20 border border-red-500 rounded-lg">
                <h3 class="text-xl font-semibold text-red-400">Analysis Failed</h3>
                <p id="error-message" class="mt-2 text-red-300"></p>
            </div>
            <div id="results-content" class="hidden space-y-6"></div>
        </div>
    </div>

    <script>
    // --- API Keys ---
    const GEMINI_API_KEY = "AIzaSyBNZRpbEG_cdgKra0ByDVqtCdZro-uTk_M";
    const GOOGLE_CLIENT_ID = "447933251845-25uu1hu0qmgf8so56o7ne52e4mo23384.apps.googleusercontent.com";
    const GAPI_SCOPES = "https://www.googleapis.com/auth/webmasters.readonly https://www.googleapis.com/auth/spreadsheets";

    // --- DOM References ---
    const authButton = document.getElementById('auth-button');
    const authSection = document.getElementById('auth-section');
    const configSection = document.getElementById('config-section');
    const gscLoader = document.getElementById('gsc-loader');
    const gscConfigInputs = document.getElementById('gsc-config-inputs');
    const gscUrlSelect = document.getElementById('gsc-url-select');
    const runButton = document.getElementById('run-analysis');
    const resultsSection = document.getElementById('results-section');
    const loaderContainer = document.getElementById('loader-container');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const resultsContent = document.getElementById('results-content');
    const redditSubreddit = document.getElementById('reddit-subreddit');
    let tokenClient;
    let analysisData = {};

    window.onload = function() {
        gapi.load('client', initializeGapiClient);
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GAPI_SCOPES,
            callback: handleAuthResponse,
        });
        authButton.addEventListener('click', () => tokenClient.requestAccessToken());
        runButton.addEventListener('click', handleAnalysis);
    };

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: GEMINI_API_KEY, // Use Google Cloud API key here (they're the same in your case)
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/webmasters/v3/rest",
                "https://sheets.googleapis.com/$discovery/rest?version=v4"
            ]
        });
    }

    function handleAuthResponse(response) {
        if (response.error) {
            alert('Authentication failed. Please ensure you have added the correct URL to your Google Cloud Client ID settings.');
            return;
        }
        authSection.classList.add('hidden');
        configSection.classList.remove('hidden');
        gscLoader.classList.remove('hidden');
        fetchGscProperties();
    }

    async function fetchGscProperties() {
        try {
            const response = await gapi.client.webmasters.sites.list({});
            const sites = response.result.siteEntry;
            if (!sites || sites.length === 0) throw new Error("No GSC properties found in this account.");
            gscUrlSelect.innerHTML = sites.map(site => `<option value="${site.siteUrl}">${site.siteUrl}</option>`).join('');
            gscLoader.classList.add('hidden');
            gscConfigInputs.classList.remove('hidden');
        } catch (error) {
            console.error("Error fetching GSC properties:", error);
            gscLoader.classList.add('hidden');
            alert("Could not fetch GSC properties. Please ensure you have granted permission and have properties in your account.");
            authSection.classList.remove('hidden');
            configSection.classList.add('hidden');
        }
    }

    async function handleAnalysis() {
        const gscUrl = gscUrlSelect.value;
        const subreddit = redditSubreddit.value;
        if (!gscUrl || !subreddit) {
            alert("Please select a GSC property and enter a Subreddit.");
            return;
        }
        configSection.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        loaderContainer.classList.remove('hidden');
        errorContainer.classList.add('hidden');
        resultsContent.classList.add('hidden');
        resultsContent.innerHTML = '';
        try {
            const gscData = await fetchGscData(gscUrl);
            const redditData = await fetchRedditData(subreddit);
            const analysisResult = await performAnalysisWithGemini(gscData, redditData, gscUrl, subreddit);
            analysisData = analysisResult;
            renderResults(analysisResult);
            loaderContainer.classList.add('hidden');
            resultsContent.classList.remove('hidden');
        } catch (error) {
            console.error("Analysis failed:", error);
            loaderContainer.classList.add('hidden');
            errorMessage.textContent = error.message || "An unknown error occurred. Check the console for details.";
            errorContainer.classList.remove('hidden');
        }
    }

    async function fetchGscData(siteUrl) {
        // Fetch 28 days current and previous period
        const today = new Date();
        const endDateCurrent = new Date(today); endDateCurrent.setDate(today.getDate() - 1);
        const startDateCurrent = new Date(endDateCurrent); startDateCurrent.setDate(endDateCurrent.getDate() - 27);
        const endDatePrevious = new Date(startDateCurrent); endDatePrevious.setDate(startDateCurrent.getDate() - 1);
        const startDatePrevious = new Date(endDatePrevious); startDatePrevious.setDate(endDatePrevious.getDate() - 27);
        const formatDate = (date) => date.toISOString().split('T')[0];
        const current = await fetchSingleGscPeriod(siteUrl, formatDate(startDateCurrent), formatDate(endDateCurrent));
        const previous = await fetchSingleGscPeriod(siteUrl, formatDate(startDatePrevious), formatDate(endDatePrevious));
        return { current, previous };
    }

    async function fetchSingleGscPeriod(siteUrl, startDate, endDate) {
        const resp = await gapi.client.webmasters.searchanalytics.query({
            siteUrl,
            resource: {
                startDate,
                endDate,
                dimensions: ['query'],
                rowLimit: 5000
            }
        });
        return resp.result.rows || [];
    }

    async function fetchRedditData(subreddit) {
        const url = `https://www.reddit.com/r/${encodeURIComponent(subreddit)}/hot.json?limit=25`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Failed to fetch Reddit data.");
        const json = await resp.json();
        return (json.data && json.data.children) ? json.data.children.map(child => ({
            title: child.data.title,
            score: child.data.score,
            num_comments: child.data.num_comments,
            url: "https://reddit.com" + child.data.permalink,
            selftext: child.data.selftext
        })) : [];
    }

    async function performAnalysisWithGemini(gscData, redditData, gscUrl, subreddit) {
        const prompt = `
You are an expert Predictive SEO Analyst. Based on the provided GSC data and Reddit data, perform a comprehensive analysis.

**Analysis Parameters:**
- GSC Property URL: "${gscUrl}"
- Reddit Source: r/${subreddit}

**Provided Data:**
- GSC Current Period Data (JSON): ${JSON.stringify(gscData.current)}
- GSC Previous Period Data (JSON): ${JSON.stringify(gscData.previous)}
- Reddit Posts (JSON): ${JSON.stringify(redditData)}

**Required Steps:**
1. Analyze GSC Data for emerging, new, and untapped terms.
2. Analyze Reddit posts for trending topics.
3. Generate an overall summary and actionable recommendations.

**Output Format (Strict):**
{
  "ai_insights": { "overall_summary": "...", "actionable_recommendations": ["..."], "gsc_emerging_comment": "...", "gsc_new_comment": "...", "gsc_untapped_comment": "...", "reddit_comment": "..." },
  "gsc_emerging": [{"query": "...", "current_impressions": 0, "previous_impressions": 0, "growth_percentage": 0}],
  "gsc_new": [{"query": "...", "clicks": 0, "impressions": 0, "ctr": 0, "position": 0}],
  "gsc_untapped": [{"query": "...", "clicks": 0, "impressions": 0, "ctr": 0, "position": 0}],
  "reddit_posts": [{"title": "...", "score": 0, "num_comments": 0, "url": "...", "selftext": "..."}]
}
        `;
        const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: { responseMimeType: "application/json" }
        };
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            const errorBody = await response.json();
            throw new Error(errorBody?.error?.message || "Gemini API request failed.");
        }
        const result = await response.json();
        const jsonText = result.candidates[0].content.parts[0].text;
        return JSON.parse(jsonText);
    }

    function renderResults(data) {
        const { ai_insights } = data;
        resultsContent.innerHTML = `
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h2 class="text-2xl font-bold text-white mb-3">AI Insights</h2>
                <p class="text-gray-300 mb-3">${ai_insights.overall_summary}</p>
                <h3 class="text-lg font-semibold text-white mb-2">Actionable Recommendations</h3>
                <ul class="list-disc list-inside text-gray-300 mb-3">
                    ${ai_insights.actionable_recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-2">GSC Emerging Terms</h3>
                <p class="text-gray-400 mb-2">${ai_insights.gsc_emerging_comment}</p>
                ${createTable(data.gsc_emerging, ['query', 'current_impressions', 'previous_impressions', 'growth_percentage'])}
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-2">GSC New Terms</h3>
                <p class="text-gray-400 mb-2">${ai_insights.gsc_new_comment}</p>
                ${createTable(data.gsc_new, ['query', 'clicks', 'impressions', 'ctr', 'position'])}
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-2">GSC Untapped Terms</h3>
                <p class="text-gray-400 mb-2">${ai_insights.gsc_untapped_comment}</p>
                ${createTable(data.gsc_untapped, ['query', 'clicks', 'impressions', 'ctr', 'position'])}
            </div>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                <h3 class="text-lg font-semibold text-white mb-2">Reddit Posts</h3>
                <p class="text-gray-400 mb-2">${ai_insights.reddit_comment}</p>
                ${createTable(data.reddit_posts, ['title', 'score', 'num_comments', 'url'])}
            </div>
        `;
    }

    function createTable(dataArray, headers) {
        if (!dataArray || dataArray.length === 0) return '<p class="text-gray-500">No data available.</p>';
        let table = '<div class="overflow-x-auto"><table class="min-w-full text-left text-sm">';
        table += '<thead class="bg-gray-700/50"><tr>';
        headers.forEach(header => table += `<th class="p-3 font-semibold capitalize">${header.replace(/_/g, ' ')}</th>`);
        table += '</tr></thead><tbody class="divide-y divide-gray-700">';
        dataArray.forEach(row => {
            table += '<tr class="hover:bg-gray-700/30">';
            headers.forEach(header => {
                let value = row[header] ?? 'N/A';
                if (typeof value === 'string' && value.startsWith('http')) value = `<a href="${value}" target="_blank" class="text-blue-400 hover:underline">${value}</a>`;
                table += `<td class="p-3 break-words">${value}</td>`;
            });
            table += '</tr>';
        });
        table += '</tbody></table></div>';
        return table;
    }
    </script>
</body>
</html>
