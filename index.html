<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predictive SEO Tool</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 p-6 font-sans">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-4">🔍 Predictive SEO Tool</h1>
    <div id="g_id_onload"
         data-client_id="447933251845-25uu1hu0qmgf8so56o7ne52e4mo23384.apps.googleusercontent.com"
         data-auto_prompt="false"
         data-callback="onGoogleLogin">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>

    <div class="mt-6">
      <label class="block mb-2">Subreddit:</label>
      <input type="text" id="subreddit" value="b2bmarketing" class="w-full border p-2 rounded" />
      <label class="block mt-4 mb-2">Sort Type:</label>
      <select id="sortType" class="w-full border p-2 rounded">
        <option value="hot">Hot</option>
        <option value="new">New</option>
        <option value="top">Top</option>
        <option value="rising">Rising</option>
        <option value="controversial">Controversial</option>
        <option value="gilded">Gilded</option>
      </select>
      <label class="block mt-4 mb-2">GSC Property URL:</label>
      <input type="text" id="gsc-url" value="https://hallam.agency/" class="w-full border p-2 rounded" />
      <button id="fetch-data" class="mt-6 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Run Full Analysis</button>
    </div>
    <pre id="status" class="mt-6 bg-white p-4 border rounded h-60 overflow-auto text-sm"></pre>
    <button id="download-xlsx" class="hidden mt-4 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">📥 Download XLSX Report</button>
  </div>

  <script>
    const GEMINI_API_KEY = 'AIzaSyBNZRpbEG_cdgKra0ByDVqtCdZro-uTk_M';
    const REDDIT_CLIENT_ID = 'FhzWxs4ciMA2Qz1HB590NQ';
    const REDDIT_CLIENT_SECRET = 'JqB8jI7oFttg0Qd9mx3gS81Q-qTHlw';
    const REDDIT_AUTH_URL = 'https://www.reddit.com/api/v1/access_token';

    let gAccessToken = null;

    function onGoogleLogin(response) {
      gAccessToken = response.credential;
      log('✅ Google Identity login complete.');
    }

    const log = (msg) => {
      const el = document.getElementById('status');
      el.textContent += `\n${msg}`;
      el.scrollTop = el.scrollHeight;
    };

    function getDateRange(offsetDays = 0) {
      const end = new Date(Date.now() - offsetDays * 86400000);
      const start = new Date(end);
      start.setDate(end.getDate() - 27);
      return [start.toISOString().split('T')[0], end.toISOString().split('T')[0]];
    }

    async function gscQuery(siteUrl, startDate, endDate) {
      const body = {
        startDate,
        endDate,
        dimensions: ['query'],
        rowLimit: 25000
      };
      const res = await fetch(`https://searchconsole.googleapis.com/v1/sites/${encodeURIComponent(siteUrl)}/searchAnalytics/query`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${gAccessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      return data.rows?.map(r => ({
        query: r.keys[0],
        clicks: r.clicks,
        impressions: r.impressions,
        ctr: r.ctr,
        position: r.position
      })) || [];
    }

    function analyzeEmerging(current, previous, threshold = 0.5, minImpressions = 100) {
      const prevMap = new Map(previous.map(d => [d.query, d]));
      return current.filter(d => {
        const prev = prevMap.get(d.query);
        if (!prev) return false;
        const growth = (d.impressions - prev.impressions) / (prev.impressions || 1);
        return d.impressions >= minImpressions && growth >= threshold;
      });
    }

    function analyzeNew(current, previous) {
      const prevSet = new Set(previous.map(d => d.query));
      return current.filter(d => !prevSet.has(d.query));
    }

    function analyzeUntapped(current, minImpressions = 500, maxCTR = 0.015) {
      return current.filter(d => d.impressions >= minImpressions && d.ctr <= maxCTR);
    }

    async function authenticateReddit() {
      const res = await fetch(REDDIT_AUTH_URL, {
        method: 'POST',
        headers: {
          'Authorization': 'Basic ' + btoa(`${REDDIT_CLIENT_ID}:${REDDIT_CLIENT_SECRET}`),
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'grant_type=client_credentials'
      });
      return (await res.json()).access_token;
    }

    async function fetchReddit(subreddit, sort) {
      const token = await authenticateReddit();
      const res = await fetch(`https://oauth.reddit.com/r/${subreddit}/${sort}?limit=25`, {
        headers: {
          Authorization: `Bearer ${token}`,
          'User-Agent': 'Nosy Parker'
        }
      });
      const json = await res.json();
      return json.data.children.map(p => p.data);
    }

    async function fetchGeminiInsights(emerging, newTerms, untapped, reddit) {
      const prompt = `Analyze:\n\nGSC Emerging:\n${JSON.stringify(emerging)}\n\nGSC New:\n${JSON.stringify(newTerms)}\n\nGSC Untapped:\n${JSON.stringify(untapped)}\n\nReddit Posts:\n${JSON.stringify(reddit)}`;

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const json = await res.json();
      return json.candidates?.[0]?.content?.parts?.[0]?.text || 'No insights returned.';
    }

    function exportXLSX(emerging, newTerms, untapped, reddit, insights) {
      const wb = XLSX.utils.book_new();
      const wrap = (data, sheetName) => {
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.sheet_add_aoa(ws, [["Insights:"], [insights], []], { origin: 'A1' });
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      };
      wrap(emerging, 'Emerging');
      wrap(newTerms, 'New');
      wrap(untapped, 'Untapped');
      wrap(reddit, 'Reddit');
      XLSX.writeFile(wb, 'predictive_seo_report.xlsx');
    }

    document.getElementById('fetch-data').addEventListener('click', async () => {
      const url = document.getElementById('gsc-url').value;
      const subreddit = document.getElementById('subreddit').value;
      const sort = document.getElementById('sortType').value;

      const [currStart, currEnd] = getDateRange(1);
      const [prevStart, prevEnd] = getDateRange(29);

      log(`📊 Fetching GSC data: ${currStart} → ${currEnd}`);
      const current = await gscQuery(url, currStart, currEnd);
      log(`📊 Fetching previous GSC data: ${prevStart} → ${prevEnd}`);
      const previous = await gscQuery(url, prevStart, prevEnd);

      const emerging = analyzeEmerging(current, previous);
      const newTerms = analyzeNew(current, previous);
      const untapped = analyzeUntapped(current);

      log(`📥 Fetching Reddit data from r/${subreddit} sorted by ${sort}`);
      const reddit = await fetchReddit(subreddit, sort);

      log(`🤖 Sending data to Gemini API`);
      const insights = await fetchGeminiInsights(emerging, newTerms, untapped, reddit);

      exportXLSX(emerging, newTerms, untapped, reddit, insights);
      document.getElementById('download-xlsx').classList.remove('hidden');
      log(`✅ XLSX download ready.`);
    });
  </script>
</body>
</html>
