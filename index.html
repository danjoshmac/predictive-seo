<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Predictive SEO Analysis Tool</title>
  <!-- Tailwind CDN (demo only) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"/>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    body { font-family:Inter,sans-serif; background:#111827; color:#f3f4f6; }
    .btn { padding:.75rem 1.25rem; border-radius:.375rem; font-weight:600; cursor:pointer; }
    .btn-primary { background:#3b82f6; color:#fff; }
    .btn-disabled { opacity:.5; pointer-events:none; }
    select,input { width:100%; padding:.5rem; border-radius:.375rem; background:#374151; color:#f3f4f6; border:1px solid #4b5563; }
    .loader { border:4px solid #f3f3f3; border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:2rem auto; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .container{max-width:600px;margin:2rem auto}
    h1,h2{color:#fff;margin-bottom:1rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>Predictive SEO Analysis Tool</h1>

    <div id="auth-section">
      <button id="auth-button" class="btn btn-primary btn-disabled">Sign in with Google</button>
      <p>Requires Search Console &amp; Sheets OAuth</p>
    </div>

    <div id="config-section" class="hidden space-y-4">
      <h2>1. Pick a GSC Property</h2>
      <div id="gsc-loader" class="loader hidden"></div>
      <div id="gsc-inputs" class="hidden">
        <select id="gsc-url"></select>
      </div>

      <h2>2. Reddit Settings</h2>
      <input type="text" id="reddit-subreddit" placeholder="Subreddit (e.g. b2bmarketing)" />
      <select id="reddit-sort">
        <option>Hot</option><option>New</option><option>Top</option>
      </select>

      <button id="run-button" class="btn btn-primary btn-disabled">Run Analysis</button>
    </div>

    <div id="results-section" class="hidden space-y-4">
      <div id="loader" class="loader hidden"></div>
      <div id="error" class="hidden text-red-400"></div>
      <pre id="results-content" class="bg-gray-800 p-4 rounded overflow-auto text-sm"></pre>
    </div>
  </div>

  <script>
  // --- CONFIG ---
  const GOOGLE_CLIENT_ID = '64568371966-4m8l8mp16mta4s8eriabdlecncdgumea.apps.googleusercontent.com';
  const GSC_API_BASE     = 'https://www.googleapis.com/webmasters/v3';
  const SCOPES           = 'https://www.googleapis.com/auth/webmasters.readonly https://www.googleapis.com/auth/spreadsheets';

  let accessToken = '';
  let tokenClient;

  // DOM refs
  const authBtn      = document.getElementById('auth-button');
  const runBtn       = document.getElementById('run-button');
  const gscLoader    = document.getElementById('gsc-loader');
  const gscInputs    = document.getElementById('gsc-inputs');
  const gscSelect    = document.getElementById('gsc-url');
  const redditInput  = document.getElementById('reddit-subreddit');
  const redditSort   = document.getElementById('reddit-sort');
  const resultsSec   = document.getElementById('results-section');
  const loader       = document.getElementById('loader');
  const errorDiv     = document.getElementById('error');
  const resultsPre   = document.getElementById('results-content');

  // --- AUTH SETUP ---
  window.onload = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: SCOPES,
      callback: resp => {
        if (resp.error) return alert('Auth error: ' + resp.error);
        accessToken = resp.access_token;
        initConfigUI();
      }
    });
    authBtn.classList.remove('btn-disabled');
    authBtn.onclick = () => tokenClient.requestAccessToken();
  };

  // --- CONFIG UI ---
  async function initConfigUI() {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('config-section').classList.remove('hidden');
    gscLoader.classList.remove('hidden');

    try {
      const res = await fetch(`${GSC_API_BASE}/sites`, {
        headers: { 'Authorization': 'Bearer ' + accessToken }
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      // data.siteEntry is an array of {siteUrl, permissionLevel}
      gscSelect.innerHTML = data.siteEntry.map(s=>`<option>${s.siteUrl}</option>`).join('');
      gscLoader.classList.add('hidden');
      gscInputs.classList.remove('hidden');
      runBtn.classList.remove('btn-disabled');
      runBtn.onclick = runAnalysis;
    } catch (e) {
      gscLoader.classList.add('hidden');
      alert('Could not fetch GSC properties:\n' + e.message);
    }
  }

  // --- RUN ANALYSIS ---
  async function runAnalysis() {
    const property = gscSelect.value;
    const subreddit = redditInput.value.trim();
    const sort = redditSort.value;
    if (!property || !subreddit) {
      return alert('Please select a property and enter a subreddit.');
    }

    // Show loaders
    resultsSec.classList.remove('hidden');
    loader.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    resultsPre.textContent = '';

    try {
      // Fetch last 28 days vs previous 28 days
      const today = new Date();
      const end1 = new Date(today); end1.setDate(end1.getDate()-1);
      const start1 = new Date(end1); start1.setDate(start1.getDate()-27);
      const end2 = new Date(start1); end2.setDate(end2.getDate()-1);
      const start2 = new Date(end2); start2.setDate(end2.getDate()-27);
      const fmt = d => d.toISOString().slice(0,10);

      const [current, previous] = await Promise.all([
        queryAnalytics(property, fmt(start1), fmt(end1)),
        queryAnalytics(property, fmt(start2), fmt(end2))
      ]);

      // (For brevity weâ€™ll just dump those two arrays + reddit params)
      const result = { current, previous, reddit:{subreddit,sort} };

      // Display everything
      resultsPre.textContent = JSON.stringify(result, null, 2);
    } catch (e) {
      console.error(e);
      errorDiv.textContent = e.message;
      errorDiv.classList.remove('hidden');
    } finally {
      loader.classList.add('hidden');
    }
  }

  // Helper: call searchanalytics/query
  async function queryAnalytics(siteUrl, startDate, endDate) {
    const body = {
      startDate, endDate,
      dimensions: ['query'],
      rowLimit: 5000
    };
    const res = await fetch(`${GSC_API_BASE}/sites/${encodeURIComponent(siteUrl)}/searchAnalytics/query`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + accessToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(await res.text());
    const js = await res.json();
    return js.rows || [];
  }
  </script>
</body>
</html>
