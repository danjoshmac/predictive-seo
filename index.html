<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Predictive SEO Analysis Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <style>
    body { font-family:'Inter',sans-serif; background:#111827; color:#f3f4f6 }
    .loader { border:4px solid #f3f3f3; border-top:4px solid #3b82f6; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite }
    @keyframes spin { to{transform:rotate(360deg)} }
    .input-field { background:#374151; border-color:#4b5563; color:#f3f4f6 }
    .input-field:focus { background:#4b5563; border-color:#3b82f6; outline:none }
    .accordion-button { transition:background-color .2s }
    .accordion-content { max-height:0; overflow:hidden; transition:max-height .3s }
  </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
  <div class="container mx-auto max-w-5xl">
    <header class="text-center mb-10">
      <h1 class="text-4xl sm:text-5xl font-bold">Predictive SEO Analysis Tool</h1>
      <p class="text-gray-400 mt-3">Connect your accounts to uncover emerging trends and content opportunities.</p>
    </header>

    <!-- AUTH -->
    <div id="auth-section" class="text-center">
      <button id="auth-button"
              disabled
              class="bg-white text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md flex items-center justify-center mx-auto hover:bg-gray-200 transition disabled:opacity-50">
        <!-- Google G -->
        <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48">
          <path fill="#4285F4" d="M45.12 24.5c0-1.56..."/>
        </svg>
        Sign in with Google
      </button>
      <p class="text-xs text-gray-500 mt-3">Required for Search Console &amp; Sheets access.</p>
    </div>

    <!-- CONFIG -->
    <div id="config-section" class="hidden space-y-8">
      <!-- GSC -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">1. Google Search Console</h2>
        <div id="gsc-loader" class="text-center hidden">
          <p class="text-gray-400">Loading your GSC properties…</p>
        </div>
        <div id="gsc-config-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="gsc-url-select" class="block text-sm font-medium mb-1">Select Property</label>
            <select id="gsc-url-select" class="w-full p-2 rounded input-field"></select>
          </div>
          <div>
            <label for="gsc-emerging-threshold" class="block text-sm font-medium mb-1">'Emerging' Threshold (%)</label>
            <input type="number" id="gsc-emerging-threshold" class="w-full p-2 rounded input-field" value="50">
          </div>
          <div>
            <label for="gsc-emerging-min-impressions" class="block text-sm font-medium mb-1">'Emerging' Min</label>
            <input type="number" id="gsc-emerging-min-impressions" class="w-full p-2 rounded input-field" value="100">
          </div>
          <div>
            <label for="gsc-untapped-min-impressions" class="block text-sm font-medium mb-1">'Untapped' Min</label>
            <input type="number" id="gsc-untapped-min-impressions" class="w-full p-2 rounded input-field" value="500">
          </div>
          <div>
            <label for="gsc-untapped-max-ctr" class="block text-sm font-medium mb-1">'Untapped' Max CTR (%)</label>
            <input type="number" id="gsc-untapped-max-ctr" class="w-full p-2 rounded input-field" value="1.5">
          </div>
        </div>
      </div>

      <!-- Reddit -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-3">2. Reddit</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="reddit-subreddit" class="block text-sm font-medium mb-1">Subreddit</label>
            <input type="text" id="reddit-subreddit" class="w-full p-2 rounded input-field" placeholder="b2bmarketing">
          </div>
          <div>
            <label for="reddit-sort" class="block text-sm font-medium mb-1">Sort</label>
            <select id="reddit-sort" class="w-full p-2 rounded input-field">
              <option>Hot</option><option>New</option><option>Top</option><option>Rising</option><option>Controversial</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Run -->
      <div class="text-center pt-4">
        <button id="run-analysis"
                disabled
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transform hover:scale-105 transition disabled:opacity-50">
          Run Predictive Analysis
        </button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="results-section" class="hidden mt-12">
      <div id="loader-container" class="text-center py-10">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-lg text-gray-300">Performing analysis…</p>
      </div>
      <div id="error-container" class="hidden text-center p-6 bg-red-900/20 border border-red-500 rounded-lg">
        <h3 class="text-xl font-semibold text-red-400">Analysis Failed</h3>
        <p id="error-message" class="mt-2 text-red-300"></p>
      </div>
      <div id="results-content" class="hidden space-y-6"></div>
    </div>
  </div>

  <script>
    // --- Config ---
    const GEMINI_API_KEY   = "AIzaSyANQlM8nra-lcWuNf2bC5tyxBexdH-flfk";
    const GOOGLE_CLIENT_ID = "64568371966-4m8l8mp16mta4s8eriabdlecncdgumea.apps.googleusercontent.com";
    const GAPI_SCOPES      = "https://www.googleapis.com/auth/webmasters.readonly https://www.googleapis.com/auth/spreadsheets";

    let tokenClient, analysisData = {};

    // DOM refs
    const authButton      = document.getElementById("auth-button");
    const runButton       = document.getElementById("run-analysis");
    const authSection     = document.getElementById("auth-section");
    const configSection   = document.getElementById("config-section");
    const gscLoader       = document.getElementById("gsc-loader");
    const gscInputs       = document.getElementById("gsc-config-inputs");
    const gscUrlSelect    = document.getElementById("gsc-url-select");
    const resultsSection  = document.getElementById("results-section");
    const loaderContainer = document.getElementById("loader-container");
    const errorContainer  = document.getElementById("error-container");
    const errorMessage    = document.getElementById("error-message");
    const resultsContent  = document.getElementById("results-content");

    window.onload = () => {
      // 1) Load the gapi.client library *and* both discovery docs
      gapi.load("client", async () => {
        try {
          await gapi.client.init({
            discoveryDocs: [
              "https://searchconsole.googleapis.com/$discovery/rest?version=v1",
              "https://sheets.googleapis.com/$discovery/rest?version=v4"
            ]
          });

          // 2) Now that searchconsole & sheets are wired, enable sign‑in
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GAPI_SCOPES,
            callback: handleAuthResponse
          });
          authButton.disabled = false;
          authButton.addEventListener("click", () => tokenClient.requestAccessToken());

          // 3) Enable the “Run” button after sign‑in (we wire up the handler here)
          runButton.addEventListener("click", handleAnalysis);
        } catch (e) {
          console.error("Failed to initialize GAPI client:", e);
          alert("Error loading Google APIs: " + e.message);
        }
      });
    };

    // OAuth callback
    async function handleAuthResponse(resp) {
      console.log("Authentication response:", resp);
      if (resp.error) {
        alert("Authentication failed: " + resp.error);
        return;
      }
      // install token
      gapi.client.setToken(resp);

      // switch UI
      authSection.classList.add("hidden");
      configSection.classList.remove("hidden");
      gscLoader.classList.remove("hidden");

      // fetch the list of GSC properties
      await fetchGscProperties();
      runButton.disabled = false;
    }

    // pull the site list
    async function fetchGscProperties() {
      try {
        const res = await gapi.client.searchconsole.sites.list({});
        const sites = res.result.siteEntry;
        if (!sites || !sites.length) throw new Error("No properties found");
        gscUrlSelect.innerHTML = sites
          .map(s => `<option value="${s.siteUrl}">${s.siteUrl}</option>`)
          .join("");
        gscLoader.classList.add("hidden");
        gscInputs.classList.remove("hidden");
      } catch (err) {
        console.error("Error fetching GSC properties:", err);
        alert("Could not fetch GSC properties.\n\n" + err.message);
        gscLoader.classList.add("hidden");
        authSection.classList.remove("hidden");
        configSection.classList.add("hidden");
      }
    }

    // … all of your existing functions: fetchAllGscData, performAnalysisWithGemini,
    //     handleAnalysis, renderResults, createAccordionSection, createTable, exportToSheets …
    // Just drop them in here, unchanged.
  </script>
</body>
</html>
